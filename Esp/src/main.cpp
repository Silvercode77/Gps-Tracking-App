#include <Arduino.h>
#include <PubSubClient.h>
#include <TinyGPS++.h>
#include <WiFi.h>
#include <HardwareSerial.h>
const char* ssid = "TUNISIETELECOM-2.4G-7zFD";
const char* password = "Za5*q.s-eR/";
/*const char* ssid = "hana";
const char* password = "hanahana";*/
// HiveMQ public broker details
const char* mqtt_server = "broker.emqx.io";
const int mqtt_port = 1883; // Default non-secure MQTT port
const char* mqtt_topic = "test/esp32"; // Topic to publish to

 int i;
// Create WiFi and MQTT client objects
TinyGPSPlus gps;
HardwareSerial gpsSerial(2);
WiFiClient espClient;  
PubSubClient client(espClient);
// Function to connect to WiFi
void setup_wifi() {
  Serial.begin(115200);
  delay(10);
  Serial.print("Connection WiFi en cours...");
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println();
  Serial.println("WiFi Connecte!");
  Serial.print("addresse IP : ");
  Serial.println(WiFi.localIP());
}

void reconnect() {
  while (!client.connected()) {
    Serial.print("Connection au broker MQTT en cours...");
    if (client.connect("EsPUnIQUe")){ //client.connect("EsP32OmeK","emqx_online_test_17c72050", "29d8e8f4cKaR56)3A8ad9e2Vb:E#80_a"))
      Serial.println("Connecte!");
    } else {
      Serial.print("ECHOUE rc=");
      Serial.print(client.state());
      Serial.println(" Reconnecion dans 5 secondes");
      delay(5000);
    }
  }
}





const char* parse(uint8_t i,float lat,float lng){
char c=gpsSerial.read();
gps.encode(c);

  String location="{\"bus_id\":"+String(i)+",\"latitude\":"+String(gps.location.lat()+lat,8)+",\"longitude\":"+String(gps.location.lng()+lng,8)+"}";
  
  const char* d= location.c_str();
  return d;
}
void setup() {
  setup_wifi();
  client.setServer(mqtt_server, mqtt_port);
}

void loop() {


  if (!client.connected()) {
    reconnect();
  }
 
  double gps1[100][2] = {
    {36.864396, 10.251765},
    {36.864058, 10.251966},
    {36.863914, 10.252051},
    {36.863241, 10.2525},
    {36.863189, 10.253098},
    {36.863175, 10.253266},
    {36.863161, 10.253401},
    {36.862659, 10.25373},
    {36.862335, 10.25394},
    {36.861915, 10.254222},
    {36.861811, 10.254281},
    {36.861801, 10.254275},
    {36.861766, 10.254267},
    {36.861732, 10.254278},
    {36.861704, 10.254304},
    {36.861688, 10.254336},
    {36.861682, 10.254372},
    {36.861141, 10.25472},
    {36.860724, 10.254997},
    {36.860391, 10.255219},
    {36.860053, 10.255421},
    {36.859765, 10.255605},
    {36.859545, 10.255717},
    {36.859503, 10.255739},
    {36.85938, 10.255796},
    {36.85932, 10.255817},
    {36.859244, 10.255843},
    {36.858892, 10.255922},
    {36.858582, 10.255986},
    {36.858545, 10.255974},
    {36.858532, 10.255969},
    {36.858482, 10.255983},
    {36.858442, 10.256022},
    {36.858436, 10.256038},
    {36.858421, 10.256076},
    {36.858304, 10.256117},
    {36.858219, 10.25615},
    {36.857714, 10.256319},
    {36.85727, 10.256447},
    {36.856731, 10.256614},
    {36.856134, 10.256793},
    {36.856019, 10.256828},
    {36.855605, 10.25696},
    {36.855013, 10.257133},
    {36.854706, 10.257214},
    {36.854124, 10.25738},
    {36.85394, 10.257441},
    {36.853596, 10.257529},
    {36.853332, 10.257594},
    {36.853308, 10.257578},
    {36.853264, 10.257567},
    {36.853219, 10.257579},
    {36.853182, 10.257611},
    {36.853157, 10.257659},
    {36.853031, 10.257701},
    {36.852793, 10.257783},
    {36.852355, 10.257927},
    {36.851989, 10.258024},
    {36.851659, 10.25811},
    {36.851555, 10.258142},
    {36.851437, 10.25819},
    {36.851352, 10.258228},
    {36.851215, 10.258302},
    {36.851047, 10.258398},
    {36.850476, 10.25874},
    {36.85037, 10.258794},
    {36.849868, 10.259102},
    {36.849666, 10.259226},
    {36.849325, 10.259391},
    {36.849276, 10.259363},
    {36.849223, 10.259356},
    {36.84917, 10.259371},
    {36.849125, 10.259407},
    {36.849091, 10.259459},
    {36.8489, 10.25956},
    {36.848713, 10.259645},
    {36.848043, 10.259997},
    {36.847946, 10.260044},
    {36.847854, 10.260072},
    {36.847767, 10.260034},
    {36.847684, 10.259999},
    {36.84761, 10.259932},
    {36.847538, 10.259804},
    {36.847455, 10.259632},
    {36.847298, 10.259286},
    {36.84715, 10.258948},
    {36.847041, 10.258693},
    {36.846906, 10.258484},
    {36.84679, 10.258216},
    {36.846333, 10.257159},
    {36.846131, 10.25659},
    {36.845877, 10.255968},
    {36.845792, 10.255732},
    {36.845513, 10.254965},
    {36.844991, 10.253495},
    {36.844793, 10.252926},
    {36.844426, 10.251982},
    {36.844072, 10.250915},
    {36.843656, 10.249769},
    {36.842714, 10.247219}
};

double gps2[100][2] = {
  { 37.071718, 11.047018 },
  { 37.071716, 11.04694 },
  { 37.071696, 11.046871 },
  { 37.071708, 11.046692 },
  { 37.071708, 11.046634 },
  { 37.07165, 11.046466 },
  { 37.071597, 11.04636 },
  { 37.07156, 11.046276 },
  { 37.071525, 11.046184 },
  { 37.071513, 11.046029 },
  { 37.071521, 11.045858 },
  { 37.071522, 11.045713 },
  { 37.071425, 11.044856 },
  { 37.071388, 11.044387 },
  { 37.071305, 11.043535 },
  { 37.071252, 11.043006 },
  { 37.071181, 11.042594 },
  { 37.071092, 11.042187 },
  { 37.071045, 11.042088 },
  { 37.070977, 11.042035 },
  { 37.0709, 11.042014 },
  { 37.070381, 11.041946 },
  { 37.070248, 11.041971 },
  { 37.070142, 11.042036 },
  { 37.070044, 11.042124 },
  { 37.06996, 11.042175 },
  { 37.069888, 11.042169 },
  { 37.069841, 11.042126 },
  { 37.069824, 11.042055 },
  { 37.06978, 11.041579 },
  { 37.069741, 11.041397 },
  { 37.069628, 11.041156 },
  { 37.069493, 11.040856 },
  { 37.069356, 11.04058 },
  { 37.069283, 11.040318 },
  { 37.069254, 11.040139 },
  { 37.069202, 11.039176 },
  { 37.069139, 11.038302 },
  { 37.069127, 11.038051 },
  { 37.069168, 11.037688 },
  { 37.069214, 11.037359 },
  { 37.069284, 11.03675 },
  { 37.069304, 11.036538 },
  { 37.069271, 11.036161 },
  { 37.069235, 11.035795 },
  { 37.069234, 11.035653 },
  { 37.069299, 11.035375 },
  { 37.06947, 11.034789 },
  { 37.069588, 11.034247 },
  { 37.069589, 11.034133 },
  { 37.069559, 11.034077 },
  { 37.069495, 11.034067 },
  { 37.069371, 11.034152 },
  { 37.068979, 11.034451 },
  { 37.068771, 11.034687 },
  { 37.068704, 11.034715 },
  { 37.068647, 11.034679 },
  { 37.068633, 11.034601 },
  { 37.068777, 11.033526 },
  { 37.068791, 11.033402 },
  { 37.068765, 11.033341 },
  { 37.06831, 11.03286 },
  { 37.06821, 11.032729 },
  { 37.068105, 11.032497 },
  { 37.06798, 11.032147 },
  { 37.067939, 11.032122 },
  { 37.067878, 11.032128 },
  { 37.067829, 11.03216 },
  { 37.067775, 11.032223 },
  { 37.067589, 11.032553 },
  { 37.067294, 11.033144 },
  { 37.067049, 11.033693 },
  { 37.066796, 11.03427 },
  { 37.066654, 11.034565 },
  { 37.066512, 11.03486 },
  { 37.066378, 11.035114 },
  { 37.066284, 11.035264 },
  { 37.066235, 11.035309 },
  { 37.066177, 11.035337 },
  { 37.066077, 11.035323 },
  { 37.066002, 11.03527 },
  { 37.065933, 11.035119 },
  { 37.065884, 11.034963 },
  { 37.065858, 11.034837 },
  { 37.065861, 11.034611 },
  { 37.065885, 11.034322 },
  { 37.065904, 11.034112 },
  { 37.065966, 11.033809 },
  { 37.066124, 11.033306 },
  { 37.066419, 11.032407 },
  { 37.066494, 11.032117 },
  { 37.06655, 11.0318 },
  { 37.066575, 11.031467 },
  { 37.066613, 11.031055 },
  { 37.066659, 11.030628 },
  { 37.06665, 11.030333 },
  { 37.066658, 11.030191 },
  { 37.066675, 11.0301 },
  { 37.066789, 11.029728 },
  { 37.066807, 11.029646 }
};

  //i=i+0.000001;
  
  /*client.publish("GPS/BUS1",parse(1,36.864429+i,10.251863+i));

  client.publish("GPS/BUS2",parse(2,37.1245+i,11.164812+i));
  client.publish("GPS/BUS3",parse(3,37.1245+i,11.164812+i));*/

  client.publish("GPS/BUS1",parse(1,gps1[i][0],gps1[i][1]));

  client.publish("GPS/BUS2",parse(2,gps2[i][0],gps2[i][1]));
  i++;
  delay(2000);
  
  
  
}
